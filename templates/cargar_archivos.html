{% extends "base.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Cargar Archivos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<div class="container mt-5">
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}
    <h3>Gestión de Archivos</h3>
    
    <!-- Formulario para subir archivos -->
    <form method="POST" enctype="multipart/form-data" class="mb-4">
        <div class="input-group">
            <input type="file" name="archivo" class="form-control" required>
            <button class="btn btn-primary" type="submit">Subir Archivo</button>
        </div>
    </form>

    <!-- Lista de archivos -->
   <table class="table table-striped">
    <thead>
        <tr>
            <th>Archivo</th>
            <th>Tamaño</th>
            <th>Fecha de carga</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
        {% for archivo in archivos %}
        <tr>
            <td>{{ archivo.icono }} {{ archivo.nombre }}</td>
            <td>{{ archivo.tamaño }}</td>
            <td>{{ archivo.fecha }}</td>
            <td>
                <!-- Descargar: todos pueden -->
                <a href="{{ url_for('cargar_archivos.descargar_archivo', filename=archivo.nombre) }}"
                    class="btn btn-success btn-sm">Descargar</a>
                
                <!-- Analizar ZIP: solo ADMIN / ENGINEER -->
                {% if role in ["ADMIN", "ENGINEER"] and archivo.extension == "zip" %}
                <a href="{{ url_for('analizar_archivos.analizar_zip', filename=archivo.nombre) }}"
                    class="btn btn-warning btn-sm"
                    target="_blank" rel="noopener noreferrer">
                    Analizar
                </a>
                {% endif %}

                {% if role in ["ADMIN", "ENGINEER"] and archivo.extension in ["ahs", "adu"] %}
                    <a href="{{ url_for('analizar_archivos.analizar_texto',
                                        filename=archivo.nombre) }}"
                    class="btn btn-info btn-sm"
                    target="_blank">
                        Analizar
                    </a>

                {% elif archivo.extension == "xml" %}
                    <a href="{{ url_for('analizar_archivos.analizar_adu',
                                        filename=archivo.nombre) }}"
                    target="_blank"
                    class="btn btn-sm btn-outline-warning">
                        Ver ADU
                    </a>
                {% endif %}

                {% if role in ["ADMIN", "ENGINEER"] and archivo.nombre.lower().endswith(".zip") %}
                <a href="{{ url_for('analizar_archivos.analizar_adu', filename=archivo.nombre) }}"
                    class="btn btn-warning btn-sm"
                    target="_blank">
                    Analizar ADU
                </a>
                {% endif %}
                {% if role in ["ADMIN", "ENGINEER"] and archivo.extension == "csv" %}
                <a href="{{ url_for('analizar_archivos.analizar_iml', filename=archivo.nombre) }}"
                    class="btn btn-info btn-sm"
                    target="_blank">
                    Analizar
                </a>
                {% endif %}
                
                <!-- Eliminar: solo ADMIN y ENGINEER -->
                {% if role in ["ADMIN", "ENGINEER"] %}
                <a href="{{ url_for('cargar_archivos.eliminar_archivo', filename=archivo.nombre) }}" 
                    class="btn btn-danger btn-sm"
                    onclick="return confirm('¿Eliminar {{ archivo.nombre }}?')">Eliminar</a>
                {% else %}
                <span class="text-muted">No permitido</span>
                {% endif %}
            </td>
        </tr>

        {% endfor %}
    </tbody>
</table>
</div>
{% endblock %}
