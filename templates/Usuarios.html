<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Usuarios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f5f5; font-family: Arial, sans-serif; }
    .table-actions button { margin-right: 5px; }
  </style>
</head>
<body>
<div class="container py-4">

  <h1 class="mb-4">Gestión de Usuarios</h1>

  <!-- Mensajes de éxito / error -->
  {% if mensaje %}
    <div class="alert alert-{{ mensaje.tipo }}">{{ mensaje.texto }}</div>
  {% endif %}

  <div class="mb-3 d-flex justify-content-between">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearUsuarioModal">+ Crear Usuario</button>
    <a href="{{ url_for('menu.menu') }}" class="btn btn-secondary">Regresar al Menú</a>
  </div>

  <!-- Tabla de usuarios -->
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Username</th>
        <th>Localidad</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for u in usuarios %}
      <tr>
        <td>{{ u.name }}</td>
        <td>{{ u.email }}</td>
        <td>{{ u.username }}</td>
        <td>{{ u.localidad }}</td>
        <td>{{ u.role }}</td>
        <td class="table-actions">
          <!-- Editar -->
          <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editarUsuarioModal{{ u.username }}">Editar</button>
          
          <!-- Eliminar -->
          <form action="{{ url_for('eliminar_usuario', username=u.username) }}" method="POST" style="display:inline;" onsubmit="return confirm('¿Eliminar usuario {{ u.username }}?');">
            <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
          </form>
        </td>
      </tr>

      <!-- Modal Editar Usuario -->
      <div class="modal fade" id="editarUsuarioModal{{ u.username }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <form action="{{ url_for('editar_usuario', username=u.username) }}" method="POST">
              <div class="modal-header">
                <h5 class="modal-title">Editar Usuario - {{ u.username }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label>Nombre</label>
                  <input type="text" name="name" value="{{ u.name }}" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Email</label>
                  <input type="email" name="email" value="{{ u.email }}" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Username</label>
                  <input type="text" name="username" value="{{ u.username }}" class="form-control" required>
                </div>
                <div class="mb-2">
                  <label>Password (dejar en blanco para no cambiar)</label>
                  <input type="password" name="password" class="form-control">
                </div>
                <div class="mb-2">
                  <label>Localidad</label>
                  <select name="localidad" class="form-select" required>
                    <option value="QUERETARO" {% if u.localidad=='QUERETARO' %}selected{% endif %}>QUERETARO</option>
                    <option value="TULTITLAN" {% if u.localidad=='TULTITLAN' %}selected{% endif %}>TULTITLAN</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label>Rol</label>
                  <select name="role" class="form-select" required>
                    <option value="ADMIN" {% if u.role=='ADMIN' %}selected{% endif %}>ADMIN</option>
                    <option value="ENGINEER" {% if u.role=='ENGINEER' %}selected{% endif %}>ENGINEER</option>
                    <option value="GUEST" {% if u.role=='GUEST' %}selected{% endif %}>GUEST</option>
                    <option value="ClientCITI" {% if u.role=='ClientCITI' %}selected{% endif %}>ClientCITI</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">Guardar cambios</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% endfor %}
    </tbody>
  </table>

</div>

<!-- Modal Crear Usuario -->
<div class="modal fade" id="crearUsuarioModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('usuarios') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Crear Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label>Nombre</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Username</label>
            <input type="text" name="username" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Password</label>
            <input type="password" name="password" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Localidad</label>
            <select name="localidad" class="form-select" required>
              <option value="QUERETARO">QUERETARO</option>
              <option value="TULTITLAN">TULTITLAN</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Rol</label>
            <select name="role" class="form-select" required>
              <option value="ADMIN">ADMIN</option>
              <option value="ENGINEER" selected>ENGINEER</option>
              <option value="GUEST">GUEST</option>
              <option value="ClientCITI">ClientCITI</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Crear Usuario</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
