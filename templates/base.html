<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Sistema IBM{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* =========================
           Fondo general (suave)
        ========================= */
        body.ibm-body {
            background-color: #77aef5; /* azul cielo muy claro */
            min-height: 100vh;
        }
        /* =========================
           Header IBM (claro)
        ========================= */
        .ibm-header {
            background: linear-gradient(90deg, #e7f1ff, #d0e2ff);
            border-bottom: 1px solid #c6d8f5;
            color: #91c7e5;
        }

        /* =========================
           Contenedor principal
        ========================= */
        .ibm-main {
            padding: 1.5rem 0;
        }

        /* Tarjetas y bloques */
        .ibm-card {
            background: #74c6ec;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Badge alertas */
        .badge-alerta {
            background-color: #fa4d56;
            color: #fff;
            font-size: 0.85rem;
        }

        /* Alertas servicio */
        .alerta-servicio {
            background: #fff1f1;
            border-left: 4px solid #fa4d56;
            color: #f3cacc;
            font-size: 0.9rem;
        }
        .card-section {
            background: #2991f3;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #fcfdff;
        }

        .section-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fbfcff;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e0e7f0;
            padding-bottom: 0.25rem;
        }

        .required {
            color: #fa4d56;
        }
        /* Labels de inputs */
        label {
            color: #030942;
            font-weight: 500;
        }

        /* TÃ­tulos de secciones */
        .section-title {
            color: #5707eb;
            font-weight: 600;
        }

        /* Texto auxiliar */
        .form-text,
        .small-muted {
            color: #4f90f1; /* gris claro */
        }

    </style>
</head>

<body class="ibm-body">

<!-- ðŸ”· HEADER GLOBAL + ALERTAS -->
<div class="ibm-header shadow-sm mb-4">
    <div class="container-fluid px-4 py-3 d-flex flex-wrap justify-content-between align-items-center gap-3">

        <div class="fw-semibold">
            Usuario: <strong>{{ current_user }}</strong>
            <span class="mx-2">|</span>
            Rol: <strong>{{ current_role }}</strong>
            <span class="mx-2">|</span>
            Localidad: <strong>{{ current_localidad }}</strong>
        </div>

        <div class="d-flex align-items-center gap-2">
            <!-- ðŸ”” BADGE ALERTAS -->
            <span id="badgeAlertas"
                  class="badge badge-alerta d-none">
                ðŸ”” 0
            </span>

            <a href="{{ url_for('menu.menu') }}"
               class="btn btn-outline-dark btn-sm">
                Regresar al menÃº
            </a>
        </div>
    </div>

    <!-- CONTENEDOR DETALLE ALERTAS -->
    <div id="contenedorAlertas" class="container px-4 pb-3 d-none"></div>
</div>

<!-- ðŸ“¦ CONTENIDO -->
<div class="ibm-main">
    <div class="container">
        {% block content %}{% endblock %}
    </div>
</div>

<!-- =========================
     SCRIPT ALERTAS VIVAS
========================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function cargarAlertasServicio() {
    fetch("/api/alertas")
        .then(r => r.json())
        .then(alertas => {

            const badge = document.getElementById("badgeAlertas");
            const contenedor = document.getElementById("contenedorAlertas");

            if (!badge || !contenedor) return;

            // Solo alertas crÃ­ticas
            const criticas = alertas.filter(a =>
                ["servicio_proximo", "servicio_vencido", "stock_bajo"].includes(a.tipo)
            );

            if (criticas.length === 0) {
                badge.classList.add("d-none");
                contenedor.classList.add("d-none");
                contenedor.innerHTML = "";
                return;
            }

            // Mostrar badge
            badge.textContent = `ðŸ”” ${criticas.length}`;
            badge.classList.remove("d-none");

            // Mostrar detalle
            contenedor.innerHTML = "";
            contenedor.classList.remove("d-none");

            criticas.forEach(a => {
                const div = document.createElement("div");
                div.className = "alerta-servicio rounded p-3 mb-2";
                div.innerHTML = a.mensaje;
                contenedor.appendChild(div);
            });
        })
        .catch(err => console.error("Error alertas:", err));
}

document.addEventListener("DOMContentLoaded", cargarAlertasServicio);
setInterval(cargarAlertasServicio, 15 * 60 * 1000);
</script>
</body>
</html>
